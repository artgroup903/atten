<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard | Branch Attendance System</title>

  <!-- ✅ Tailwind CSS -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    body { background-color: #f8fafc; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 3px 10px rgba(0,0,0,0.1); padding: 1.5rem; }
    input, select { border: 1px solid #ccc; border-radius: 6px; padding: .5rem; width: 100%; }
    button { background: #2563eb; color: white; border-radius: 8px; padding: .6rem 1rem; }
    button:hover { background: #1d4ed8; }
    h2 { color: #1e3a8a; }
  </style>
</head>
<body class="p-6">

  <h2 class="text-3xl font-bold text-center mb-6">Admin Dashboard</h2>

  <div class="max-w-6xl mx-auto grid md:grid-cols-2 gap-8">

    <!-- 🏢 Branch Management -->
    <div class="card">
      <h3 class="text-2xl font-semibold mb-4">Manage Branches</h3>

      <div class="mb-4">
        <input id="branchName" placeholder="Branch Name" class="mb-2">
        <input id="branchLat" placeholder="Latitude" class="mb-2">
        <input id="branchLon" placeholder="Longitude" class="mb-2">
        <input id="branchRadius" placeholder="Radius (meters)" class="mb-2">
        <button id="btnAddBranch" class="w-full mb-3">➕ Add Branch</button>
      </div>

      <h4 class="font-semibold mb-2">Existing Branches</h4>
      <ul id="branchList" class="space-y-2"></ul>
    </div>

    <!-- 👥 User Management -->
    <div class="card">
      <h3 class="text-2xl font-semibold mb-4">Manage Users</h3>

      <div class="mb-4">
        <input id="userName" placeholder="Username" class="mb-2">
        <input id="userPass" placeholder="Password" class="mb-2">
        <select id="userBranch" class="mb-2"></select>
        <select id="userRole" class="mb-2">
          <option value="staff">Staff</option>
          <option value="admin">Admin</option>
        </select>
        <button id="btnCreateUser" class="w-full mb-3">👤 Create User</button>
      </div>

      <h4 class="font-semibold mb-2">Existing Users</h4>
      <ul id="userList" class="space-y-2"></ul>
    </div>
  </div>

  <!-- ✅ Firebase & Admin Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      deleteDoc,
      doc,
      serverTimestamp,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // ✅ Firebase Config (same as your project)
    const firebaseConfig = {
      apiKey: "AIzaSyArh9Lqdyio6QZ276L2ciMwEgU8BgigrFs",
      authDomain: "user-atten.firebaseapp.com",
      projectId: "user-atten",
      storageBucket: "user-atten.firebasestorage.app",
      messagingSenderId: "13092297593",
      appId: "1:13092297593:web:dd99a876e5dec1714fada8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Elements
    const branchList = document.getElementById('branchList');
    const branchSelect = document.getElementById('userBranch');
    const userList = document.getElementById('userList');

    // 📍 Load Branches
    async function loadBranches() {
      branchList.innerHTML = branchSelect.innerHTML = "";
      const snaps = await getDocs(collection(db, "branches"));
      snaps.forEach((d) => {
        const b = d.data();
        const li = document.createElement("li");
        li.className = "p-3 bg-gray-100 rounded-md flex justify-between items-center";
        li.innerHTML = `
          <span>${b.name} (${b.radius_m}m)</span>
          <div class="space-x-2">
            <button class="bg-yellow-500 hover:bg-yellow-600 px-2 py-1 text-sm rounded" data-id="${d.id}" data-type="edit">Edit</button>
            <button class="bg-red-600 hover:bg-red-700 px-2 py-1 text-sm rounded" data-id="${d.id}" data-type="delete">Delete</button>
          </div>
        `;
        branchList.appendChild(li);

        const opt = document.createElement("option");
        opt.value = d.id;
        opt.textContent = b.name;
        branchSelect.appendChild(opt);
      });
    }

    // ➕ Add Branch
    document.getElementById("btnAddBranch").onclick = async () => {
      const name = document.getElementById("branchName").value.trim();
      const lat = parseFloat(document.getElementById("branchLat").value);
      const lon = parseFloat(document.getElementById("branchLon").value);
      const radius = parseInt(document.getElementById("branchRadius").value);

      if (!name || isNaN(lat) || isNaN(lon) || isNaN(radius)) return alert("⚠️ Fill all branch fields");

      await addDoc(collection(db, "branches"), {
        name,
        lat: lat,
        lng: lon,
        radius_m: radius,
        createdAt: serverTimestamp()
      });
      alert("✅ Branch added!");
      loadBranches();
    };

    // 🗑️ Edit / Delete Branch
    branchList.addEventListener("click", async (e) => {
      const id = e.target.dataset.id;
      if (!id) return;

      if (e.target.dataset.type === "delete") {
        if (!confirm("Delete this branch?")) return;
        await deleteDoc(doc(db, "branches", id));
        alert("✅ Branch deleted!");
        loadBranches();
      }

      if (e.target.dataset.type === "edit") {
        const newName = prompt("Enter new branch name:");
        if (!newName) return;
        await updateDoc(doc(db, "branches", id), { name: newName });
        alert("✅ Branch updated!");
        loadBranches();
      }
    });

    // 👤 Create User
    document.getElementById("btnCreateUser").onclick = async () => {
      const username = document.getElementById("userName").value.trim();
      const password = document.getElementById("userPass").value.trim();
      const branchId = document.getElementById("userBranch").value;
      const role = document.getElementById("userRole").value;

      if (!username || !password || !branchId) return alert("⚠️ Fill all user fields");

      await addDoc(collection(db, "users"), {
        username,
        password,
        branchId,
        role,
        deviceId: "",
        createdAt: serverTimestamp(),
      });
      alert("✅ User created!");
      loadUsers();
    };

    // 👥 Load Users
    async function loadUsers() {
      userList.innerHTML = "";
      const snaps = await getDocs(collection(db, "users"));
      snaps.forEach((d) => {
        const u = d.data();
        const li = document.createElement("li");
        li.className = "p-3 bg-gray-100 rounded-md flex justify-between items-center";
        li.innerHTML = `
          <span>${u.username} (${u.role}) - <small>${u.branchId}</small></span>
          <div class="space-x-2">
            <button class="bg-purple-500 hover:bg-purple-600 px-2 py-1 text-sm rounded" data-id="${d.id}" data-type="reset">Reset Device</button>
            <button class="bg-red-600 hover:bg-red-700 px-2 py-1 text-sm rounded" data-id="${d.id}" data-type="delete">Delete</button>
          </div>
        `;
        userList.appendChild(li);
      });
    }

    // ⚙️ Delete or Reset Device
    userList.addEventListener("click", async (e) => {
      const id = e.target.dataset.id;
      if (!id) return;

      if (e.target.dataset.type === "delete") {
        if (!confirm("Delete this user?")) return;
        await deleteDoc(doc(db, "users", id));
        alert("✅ User deleted!");
        loadUsers();
      }

      if (e.target.dataset.type === "reset") {
        await updateDoc(doc(db, "users", id), { deviceId: "" });
        alert("✅ Device reset successful!");
      }
    });

    // Initial Load
    loadBranches();
    loadUsers();
  </script>
</body>
</html>
