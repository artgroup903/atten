<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance Records | Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <style>
    body { background-color: #f4f6f8; }
    .card { background: white; border-radius: 1rem; box-shadow: 0 3px 10px rgba(0,0,0,0.1); padding: 1.5rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    th { background-color: #f0f0f0; }
  </style>
</head>
<body class="p-6">

  <h2 class="text-2xl font-bold text-center mb-6">Attendance Records</h2>

  <div class="max-w-6xl mx-auto card">
    <table>
      <thead>
        <tr>
          <th>Branch Name</th>
          <th>User Name</th>
          <th>Date</th>
          <th>Time</th>
        </tr>
      </thead>
      <tbody id="attendanceList">
        <tr><td colspan="4" class="text-center">Loading...</td></tr>
      </tbody>
    </table>
  </div>

  <!-- Firebase & Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import {
      getFirestore, collection, getDocs
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyArh9Lqdyio6QZ276L2ciMwEgU8BgigrFs",
      authDomain: "user-atten.firebaseapp.com",
      projectId: "user-atten",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const attendanceList = document.getElementById("attendanceList");

    async function loadAttendance() {
      attendanceList.innerHTML = "<tr><td colspan='4' class='text-center'>Loading...</td></tr>";

      // Load branches and users once
      const branchSnaps = await getDocs(collection(db, "branches"));
      const branchMap = {};
      branchSnaps.forEach(d => { branchMap[d.id] = d.data().name; });

      const userSnaps = await getDocs(collection(db, "users"));
      const userMap = {};
      userSnaps.forEach(d => { userMap[d.id] = d.data().username; });

      const attSnaps = await getDocs(collection(db, "attendance"));
      attendanceList.innerHTML = "";

      if(attSnaps.empty){
        attendanceList.innerHTML = "<tr><td colspan='4' class='text-center'>No attendance records found.</td></tr>";
        return;
      }

      attSnaps.forEach(d => {
  const att = d.data();

  let ts;
  if (att.timestamp?.toDate) {
    ts = att.timestamp.toDate();
  } else if (typeof att.timestamp === "number") {
    ts = new Date(att.timestamp);
  } else {
    ts = new Date();
  }

  const dateStr = ts.toLocaleDateString();
  const timeStr = ts.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const branchName = branchMap[att.branchId] || att.branchId;
  const userName = userMap[att.userId] || att.userId;

  const row = document.createElement("tr");
  row.innerHTML = `
    <td>${branchName}</td>
    <td>${userName}</td>
    <td>${dateStr}</td>
    <td>${timeStr}</td>
  `;
  attendanceList.appendChild(row);
});

    }

    // Load attendance on page load
    loadAttendance();
  </script>

</body>
</html>

